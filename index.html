<!DOCTYPE html>
<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

  <!-- Pull this into the project? -->
  <script src="https://cdn.jsdelivr.net/npm/merkletreejs@latest/merkletree.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/keccak256@latest/keccak256.js"></script>

  <link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico">

	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="SHIB Ecosystem On Pulsechain">

  <script src="pulseinu.js"></script>
  <meta charset="utf-8">
  <title>Pulseinu</title>

  <style>
    body {
      background: black;
      color: white;
      font-family: 'Poppins', sans-serif;
    }

    .nav {
        display: flex;
        align-items: center;
        justify-content: space-evenly;
        margin-top: 1%;
        padding-bottom: 1%;
        -moz-column-gap: 15%;
             column-gap: 15%;
    }

    .logo {
      display: flex;
      align-items: center;
    }

    .menu {
      display: flex;
      align-items: center;
      gap: 25px;
    }

    .actions {
      display: flex;
    }

    @font-face {
      font-family: 'Poppins';
	    src: url("/assets/fonts/PoppinsR.ttf");
      font-display: swap;
    }

  </style>
</head>

<body>
  <div class="nav">
    <div class="logo">
      <img width="80" height="80" alt="navigation logo" class="img" src="/assets/images/pinu_small.png" />
      PULSE INU
    </div>
    <div class="menu">

      <div class="dim"></div>

      <div class="dim"></div>

      <div class="twitter"></div>

      <button class="claim">Connect & Claim</button>
    </div>
  </div>


  <div style="display:none">
    <button onclick="init()" class="enableEthereumButton">Enable Ethereum</button>
    <button onclick="mintToken()" class="mintToken">Mint Token</button>
  </div>



</body>

</html>

<script>
  console.log(Web3.modules)
  // Add token
  // https://docs.metamask.io/guide/registering-your-token.html#code-free-example
  // Good overview - this is it
  // https://blog.openreplay.com/interacting-with-smart-contracts-using-web3
    const providerUrl = 'http://127.0.0.1:7545';

    const web3 = new Web3(providerUrl) // local Ganache

    // const ethereumButton = document.querySelector('.enableEthereumButton');

    // ethereumButton.addEventListener('click', () => {
    //   //Will Start the metamask extension
    //   ethereum.request({ method: 'eth_requestAccounts' });
    // });

    let selectedAccount;
    let pulseInuContract;
    let isInitialized = false

    const init = async () => {
      console.log("init triggered");

      provider = window.ethereum;

      if (typeof provider !== 'undefined') {
        provider
          .request({ method: 'eth_requestAccounts' })
          .then((accounts) => {
            selectedAccount = accounts[0];
            console.log(`Selected account is ${selectedAccount}`);
          })
          .catch((err) => {
            console.log(err);
          });

        window.ethereum.on('accountsChanged', function (accounts) {
          selectedAccount = accounts[0];
          console.log(`Selected account changed to ${selectedAccount}`);
        });
      }

      const web3 = new Web3(provider);
      const networkId = await web3.eth.net.getId(); // ???
      console.log("network id:", networkId);
      pulseInuContract = new web3.eth.Contract(PINU_ABI.abi, '0xF477e91B327BAA0685b098E8f00bc9Ce845e8b21') // add contract address on testnet);
      isInitialized = true;
    };

    const mintToken = async () => {
      if (!isInitialized) {
        await init();
      }

      let addresses = [0xF1c19135C4C194c1E4B4049E0c1bF079CBe1117F]

      // Hash leaves
      let leaves = addresses.map(addr => keccak256(addr))

      // Create tree
      let merkleTree = new MerkleTree(leaves, keccak256, {sortPairs: true})
      let rootHash = merkleTree.getRoot().toString('hex')

      console.log("root", rootHash);

      // 'Serverside' code
      let address = addresses[0]
      let hashedAddress = keccak256(address)
      let proof = merkleTree.getHexProof(hashedAddress)

      console.log("proof:", proof);

      debugger;

      let v = merkleTree.verify(proof, hashedAddress, rootHash)
      console.log("proof valid?", v) // returns true

      // generate proof for selected account
      // Clean up and put into function

      // return pulseInuContract.methods
      //   .claim(selectedAccount, proof)
      //   .send({from: selectedAccount})
    }
</script>
