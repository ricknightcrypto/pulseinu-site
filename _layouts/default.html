<!doctype html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

    <!-- Pull this into the project? -->
    <script src="https://cdn.jsdelivr.net/npm/merkletreejs@latest/merkletree.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/keccak256@latest/keccak256.js"></script>

    <link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="SHIB Ecosystem On Pulsechain">

    <script src="pulseinu.js"></script>
    <meta charset="utf-8">
    <title>Pulse Inu</title>

    <style>
        a {
            all: unset;
            cursor: pointer;
        }

        button {
            cursor: pointer;
        }

        body {
            background: black;
            color: white;
            font-family: 'Poppins', sans-serif;
        }

        .nav {
            display: flex;
            align-items: center;
            justify-content: space-evenly;
            margin-top: 5%;
            padding-bottom: 1%;
            -moz-column-gap: 15%;
            column-gap: 15%;
        }


        .logo {
            display: flex;
            align-items: center;
        }

        .title {
            font-weight: bold;
            margin-left: 19px;
            font-size: 30px;
        }

        .menu {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .actions {
            display: flex;
        }

        .header {
            text-align: center;
            font-weight: bold;
            text-align: center;
            font-weight: bold;
            font-size: 39px;
            margin-top: 4%;
            color: #D7E0FF;
        }

        .subheader {
            text-align: center;
            text-align: center;
            margin-top: 4%;
            font-size: 25px;
            color: #D7E0FF;
        }

        .action_buttons {
            text-align: center;
            font-weight: bold;
            margin-top: 4%;
            display: flex;
            justify-content: space-evenly;
        }

        @font-face {
            font-family: 'Poppins';
            src: url("/assets/fonts/PoppinsR.ttf");
            font-display: swap;
        }

        @font-face {
            font-family: 'Poppins';
            src: url("/assets/fonts/PoppinsB.ttf");
            font-weight: bold;
        }

        .connect-btn {
            height: 32px;
            border-radius: 20px;
            width: 152px;
            border: none;
            background: linear-gradient(0.25turn, #FF0000, #F00F8E, #4F30FF, #00E8FC);
            box-shadow: 0px 0px 52px rgba(204, 19, 236, 0.46);
            color: white;
            font-weight: bold;
        }

        .connect-btn-lg {
            height: 58px;
            border-radius: 50px;
            width: 243px;
            border: none;
            background: linear-gradient(0.25turn, #FF0000, #F00F8E, #4F30FF, #00E8FC);
            box-shadow: 0px 0px 52px rgba(204, 19, 236, 0.46);
            color: white;
            font-weight: bold;
            font-size: 25px;
        }

        button.mint-btn {
            border-radius: 100rem;
            font-size: 25px;
            padding: .5rem 3rem;
            color: white;
            box-shadow: 0 0 6px 0 rgba(157, 96, 212, 0.5);
            border: solid 3px transparent;
            background-image: linear-gradient(rgba(255, 255, 255, 0), rgba(255, 255, 255, 0)), linear-gradient(0.25turn, #FF0000, #F00F8E, #4F30FF, #00E8FC);
            background-origin: border-box;
            background-clip: content-box, border-box;
            box-shadow: 2px 1000px 1px black inset;
            font-weight: bold;
        }

        button.mint-btn:hover {
            box-shadow: none;
            color: white
        }

        .chart-container {
            text-align: center;
        }

        .exclusive {
            color: #f00f8e;
        }

        .pump-harder {
            color: #f60954;
        }

        .electric-blue {
            color: #00E8FC;
        }

        .store-of-val {
            margin-bottom: 5%;
        }

        .benefits {
            font-size: 20px;
        }

        @media (max-width: 800px) {

            .nav,
            .menu,
            .logo {
                flex-direction: column;
            }

            .logo {
                margin-bottom: 20px;
            }
        }

        /* Style Bulleted List */

        ul {
            list-style: none;
            /* Remove default bullets */
        }

        ul li::before {
            content: "\2022";
            color: #04defc;
            font-weight: bold;
            display: inline-block;
            width: 2em;
            margin-left: -1em;
        }
    </style>
</head>

<body>
    <div class="nav">
        <a href="/">
            <div class="logo">
                <img width="80" height="80" alt="navigation logo" class="img" src="/assets/images/pinu_small.png" />
                <span class="title">PULSE INU</span>
            </div>
        </a>
        <div class="menu">
            <a href="https://t.me/+Z5uINrmzvE9lNjNh">
                <div class="telegram">
                    <img width="22" height="22" src="/assets/images/telegram.png" />
                </div>
            </a>

            <div class="twitter">
                <img width="22" height="22" src="/assets/images/twitter.png" />
            </div>

            <button onclick="init()" class="connect-btn disconnected">Connect & Claim</button>
            <button class="connect-btn connected" style="display: none;"">Connected</button>
    </div>
</div>
    {{ content }}
</body>

</html>

<script>
    let pulseInuContract;
    let isInitialized = false
    const connectedBtn = document.getElementsByClassName('connected')[0];
    const disconnectedBtn = document.getElementsByClassName('disconnected')[0];

    // Initialize Connection to Metamask
    const init = async () => {
        provider = window.ethereum;

        if (typeof provider !== 'undefined') {
            provider
                .request({ method: 'eth_requestAccounts' })
                .then((accounts) => {
                    if (accounts[0] === undefined) {
                        connectedBtn.style.display = "none";
                        disconnectedBtn.style.display = "block";
                    } else {
                        connectedBtn.style.display = "block";
                        disconnectedBtn.style.display = "none";
                    }
                });

            window.ethereum.on('accountsChanged', function (accounts) {
                var connectedBtn = document.getElementsByClassName('connected')[0];

                if (accounts[0] === undefined) {
                    connectedBtn.style.display = "none";
                    disconnectedBtn.style.display = "block";
                } else {
                    connectedBtn.style.display = "block";
                    disconnectedBtn.style.display = "none";
                }
            });

            const web3 = new Web3(provider);
            pulseInuContract = new web3.eth.Contract(PINU_ABI.abi, '0xF477e91B327BAA0685b098E8f00bc9Ce845e8b21') // add contract address on testnet);
            isInitialized = true;
        }
    };

    init();

    const claimToken = async () => {
        if (!isInitialized) {
            await init();
        }

        let addresses = [0xF1c19135C4C194c1E4B4049E0c1bF079CBe1117F]

        // Hash leaves
        let leaves = addresses.map(addr => keccak256(addr))

        // Create tree
        let merkleTree = new MerkleTree(leaves, keccak256, { sortPairs: true })
        let rootHash = merkleTree.getRoot().toString('hex')

        console.log("root", rootHash);

        // 'Serverside' code
        let address = addresses[0] // Hmmm? Should this be selected?
        let hashedAddress = keccak256(address)
        let proof = merkleTree.getHexProof(hashedAddress)

        console.log("proof:", proof);


        let v = merkleTree.verify(proof, hashedAddress, rootHash)
        console.log("proof valid?", v) // returns true

        // Generate proof for selected account
        // Clean up and put into function

        return pulseInuContract.methods
           .claim(selectedAccount, proof)
           .send({from: selectedAccount})
    }

    /***
     *  mintToken
     *  Mint a specified amount of tokens. Should only accept PLS
     *  calls mint(plsAmount) where plsAmount is the amount of PLS minted
    */
    // const mintToken = async () => {}

</script>
